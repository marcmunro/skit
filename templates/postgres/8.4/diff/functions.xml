<?xml version="1.0" encoding="UTF-8"?>

<skit:inclusion
   xmlns:skit="http://www.bloodnok.com/xml/skit"
   xmlns:xi="http://www.w3.org/2003/XInclude">

  <dbobject type="function" key="fqn">
    <attribute name="owner">

      <!-- If the owner changes, we need either:
	   - the old owner to be superuser (we change ownership on the 
	     drop side of the DAG)
	   - the old owner to have been granted the new owner role with
	     the admin option

           TODO: Fix the depset below in line with the comment.  
	   Notes: 
	     1) the fallback role if we use the grant role to role mechanism 
	        must grant the role with the admin option (and the endfallback
		must revert back to the previous state (ie no role or
		role without admin option).
	     2) The name of the fallback pqn is incorrect
	     3) ensure fallbacks can match on pqn
	     4) need to add conditional logic to pqn handling in order
	        to only match where admin option has been granted.
	     5) We need usint tests for these cases.
	     6) The depset below should be wrapped in a conditional
	        dependencies entry (condition="backwards")
	     7) We must also have dependencies on the owner's access to
	        the parent schema.
	     8) All other object ownership diff records must be handled
	        similarly. 
      -->

      <dependency-set 
	  fallback="grant.role.{old.owner}.{new.owner}"
	  parent="ancestor::dbobject[database]">
	<dependency fqn="privilege.role.{old.owner}.superuser"/>
	<dependency pqn="grant.role.{old.owner}.{new.owner}"/>
      </dependency-set>
    </attribute>
    <attribute name="language"/>
    <attribute name="volatility"/>
    <attribute name="cost"/>
    <attribute name="rows"/>
    <attribute name="security_definer"/>
    <attribute name="is_strict"/>
    <attribute name="returns_set" rebuild="true"/>
    <attribute name="bin"/>
    <element type="result" rebuild="true">
      <attribute name="type"/>
      <attribute name="schema"/>
    </element>
    <element type="params">
      <element type="param" key="position">
	<attribute name="name"/>
	<attribute name="mode" rebuild="true"/>
	<attribute name="default" rebuild="true"/>
      </element>
    </element>
    <element type="config_setting" key="name">
      <attribute name="setting"/>
    </element>
    <element type="source">
      <text/>
    </element>
    <element type="comment">
      <text/>
    </element>
  </dbobject>	

</skit:inclusion>  
