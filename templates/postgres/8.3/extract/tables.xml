<?xml version="1.0" encoding="UTF-8"?>

<skit:inclusion
   xmlns:skit="http://www.bloodnok.com/xml/skit"
   xmlns:xi="http://www.w3.org/2003/XInclude">

  <skit:foreach var="table" from="tables" 
		filter="(string= (select table 'schema')
			         (select schema 'name'))">
    <table>
      <skit:let>
	<skit:var name="columns" expr="1"/>
      <skit:attr name="name"/>
      <skit:attr name="schema"/>
      <skit:attr name="owner"/>
      <skit:attr name="tablespace"/>
      <skit:attr name="privs"/>

      <skit:runsql var="inherits" file="sql/inherits.sql"
		   params="(select table 'oid')">
	<inherits>
	  <skit:attr name="name" field="inherit_table"/>
	  <skit:attr name="schema" field="inherit_schema"/>
	  <skit:attr name="inherit_order"/>
	</inherits>
      </skit:runsql>

      <skit:runsql to="columns" file="sql/columns.sql"
		      params="(select table 'oid')"/>
      <skit:foreach var="column" from="columns">
	<column>
	  <skit:attr name="colnum"/>
	  <skit:attr name="name"/>
	  <skit:attr name="type"/>
	  <skit:attr name="type_schema"/>
	  <skit:attr name="size"/>
	  <skit:attr name="precision"/>
	  <skit:attr name="nullable"/>
	  <skit:attr name="dimensions"/>
	  <skit:attr name="typstorage"/>
	  <skit:attr name="storage_policy"/>
	  <skit:attr name="is_local"/>
	  <skit:attr name="default"/>
	  <skit:attr name="stats_target"/>
	  <skit:if test="(select column 'comment')">
	    <comment>
	      <skit:text expr="(select column 'comment')"/>
	    </comment>
	  </skit:if>
	</column>
      </skit:foreach>

      <skit:runsql var="constraints" file="sql/table_constraints.sql"
		      params="(select table 'oid')">
	<CONSTRAINT_XX>
	  <skit:var name="colnums" expr="(split (select tuple 'columns') ',')"/>
	  <skit:attr name="name"/>
	  <skit:attr name="schema"/>
	  <skit:attr name="constraint_type"/>
	  <skit:attr name="deferred"/>
	  <skit:attr name="deferrable"/>
	  <skit:attr name="source"/>

	  <skit:attr name="columns"/>
	  <!-- <skit:exec expr="(debug 'XX' (try-to-int '1'))"/> -->
	  <skit:foreach from="colnums" var="colnum">
	    <column>
	      <skit:attr name="name" 
			 expr="(select columns (try-to-int colnum) 'name')"/>
	    </column>	
	  </skit:foreach>
	</CONSTRAINT_XX>
      </skit:runsql>

      <skit:if test="(select table 'comment')">
	<comment>
	  <skit:text expr="(select table 'comment')"/>
	</comment>
      </skit:if>

      <skit:if test="(not (select tuple 'privs'))">
        <!-- No privileges defined for this table, so create
      	     default grants for the implicit privs -->
        <grant with_grant="yes" priv="trigger" default="yes">
      	  <skit:attr name="from" field="owner"/>
      	  <skit:attr name="to" field="owner"/>
        </grant>
        <grant with_grant="yes" priv="references" default="yes">
      	  <skit:attr name="from" field="owner"/>
      	  <skit:attr name="to" field="owner"/>
        </grant>
        <grant with_grant="yes" priv="rule" default="yes">
      	  <skit:attr name="from" field="owner"/>
      	  <skit:attr name="to" field="owner"/>
        </grant>
        <grant with_grant="yes" priv="select" default="yes">
      	  <skit:attr name="from" field="owner"/>
      	  <skit:attr name="to" field="owner"/>
        </grant>
        <grant with_grant="yes" priv="insert" default="yes">
      	  <skit:attr name="from" field="owner"/>
      	  <skit:attr name="to" field="owner"/>
        </grant>
        <grant with_grant="yes" priv="update" default="yes">
      	  <skit:attr name="from" field="owner"/>
      	  <skit:attr name="to" field="owner"/>
        </grant>
        <grant with_grant="yes" priv="delete" default="yes">
      	  <skit:attr name="from" field="owner"/>
      	  <skit:attr name="to" field="owner"/>
        </grant>
      </skit:if>

      <skit:exec_function name="grants_from_privs"
    			  privileges="(select tuple 'privs')"/>
      </skit:let>
    </table>
  </skit:foreach>
</skit:inclusion>  


<!-- Keep this comment at the end of the file
Local variables:
mode: xml
sgml-omittag:nil
sgml-shorttag:nil
sgml-namecase-general:nil
sgml-general-insert-case:lower
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:2
sgml-indent-data:t
sgml-parent-document:nil
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
-->
